
##mongodb8
mkdir /tools
cd /tools/
su colombo
# tai ve source
wget https://xcoquan.vn/publish/setup_andv/mongodb-8.0.3_ubuntu24.04.tgz
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2404-8.2.1.tgz
# tai ve tool mongosh
wget https://downloads.mongodb.com/compass/mongosh-2.5.8-linux-x64.tgz

mkdir -p /u01/colombo/etc/mongodb
mkdir -p /u01/colombo/var/log/mongodb
mkdir -p /u01/colombo/var/run/mongodb

tar -xzf mongodb-linux-x86_64-ubuntu2404-8.2.1.tgz 
mv mongodb-linux-x86_64-ubuntu2404-8.2.1 mongodb
mv mongodb /u01/colombo/
sudo echo 'export PATH=/u01/colombo/mongodb/bin:$PATH' > /etc/profile.d/mongodb.sh
sudo chmod +x /etc/profile.d/mongodb.sh
sudo source /etc/profile.d/mongodb.sh
mongod --version

tar -xzf mongosh-2.5.8-linux-x64.tgz
cp mongosh-2.5.8-linux-x64/bin/mongosh /u01/colombo/mongodb/bin
chown colombo:colombo /u01/colombo/mongodb/bin/mongosh
mongosh --version

# cai cac goi phu thuoc
sudo apt-get install libcurl4 libgssapi-krb5-2 libldap-common libwrap0 libsasl2-2 libsasl2-modules libsasl2-modules-gssapi-mit openssl liblzma5

# tao keyfile khi dung internal authentication
openssl rand -base64 756 > /u01/colombo/mongodb/mongodb-keyfile
chmod 400 /u01/colombo/mongodb/mongodb-keyfile
chown colombo:colombo /u01/colombo/mongodb/mongodb-keyfile

# cau hinh shard cho cum bao gom cau hinh node luu config (data, meta), node shard, node router
# uu tien cum co so node la so le 3, 5, 7,.. de C√≥ majority toi uu, neu la so chan nhu 4, 6 nen de 1 node la backup khong cho vote + priority hoac node nay chi de aribiter chu khong ghi data do ton them disk

mkdir -p /u01/colombo/etc
mkdir -p /u01/colombo/scripts
mkdir -p /u01/colombo/var/log/mongodb
mkdir -p /u01/colombo/var/run/mongodb

# cau hinh node luu config data, 3 node configsvr
# tao duong dan luu storage
mkdir -p /u01/colombo/mongodb/wtconfig
vi /u01/colombo/etc/mongodb/wtconfig.conf
storage:
        dbPath: "/u01/colombo/mongodb/wtconfig"
        engine: wiredTiger
        wiredTiger:
            engineConfig:
                cacheSizeGB: 1
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb/wtconfig.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27019
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb/wtconfig.pid"
replication:
        replSetName: wtconfig
        oplogSizeMB: 256
sharding:
        clusterRole: configsvr
        #archiveMovedChunks: false
#security:
#        authorization: enabled
#        keyFile: "/u01/colombo/mongodb/mongodb-keyfile"
#        transitionToAuth: true

# khoi dong wtconfig 27019 tren cac node
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf
// CHU Y NEU TRONG CONFIG MONGO KHONG CO sharding: clusterRole: configsvr THI KHONG SU DUNG configsvr
// CHU Y NEU THAY DOI CONFIG MONGO THI CAN RESTART CAC NODE TRUOC KHI INITIATE
# dung cong cu mongosh de cau hinh
/u01/colombo/mongodb/bin/mongosh --port 27019
rs.initiate({
  _id: "wtconfig",
  configsvr: true,
  members: [
    { _id: 0, host: "10.60.155.240:27019", priority: 10 },
    { _id: 1, host: "10.60.155.188:27019", priority: 2 },
    { _id: 2, host: "10.60.155.165:27019", priority: 1 }
  ]
})
# tao user voi role root dung khi bat auth
use admin
db.createUser({user: "colombo", pwd: "P0rtalmongo#123DLVB", roles: [ { role: "root", db: "admin" } ]})
# tao role moi co toan quyen
db.createRole( { role: "executeFunctions", privileges: [ { resource: { anyResource: true }, actions: [ "anyAction" ] } ], roles: [] } )
# C·∫•p quy·ªÅn role v·ª´a t·∫°o cho user colombo
db.grantRolesToUser("colombo",["executeFunctions"])

# cau hinh tren cac shard
# Primary ghi full t·ªëc ƒë·ªô, kh√¥ng quan t√¢m Secondary, mac dinh Primary s·∫Ω t·ª± ƒë·ªông gi·∫£m t·ªëc ƒë·ªô ghi n·∫øu Secondary b·ªã tr·ªÖ dam bao dong bo va on dinh
#db.adminCommand( { setParameter: 1, enableFlowControl: false } )
# TƒÉng gi·ªõi h·∫°n b·ªô nh·ªõ (RAM) ƒë∆∞·ª£c ph√©p d√πng cho c√°c truy v·∫•n c√≥ sort/blocking stage. M·∫∑c ƒë·ªãnh MongoDB gi·ªõi h·∫°n kho·∫£ng 100 MB, tang lenh 320 MB
#db.adminCommand({setParameter: 1, internalQueryExecMaxBlockingSortBytes: 335544320})

# neu muon them node config server moi
# vao node moi khoi dong config server
# vao node primary config server de ket noi node moi
# rs.add("10.60.155.xxx:27019")
# vao file config router khai bao node config server moi, khoi dong lai router de cap nhat danh sach
# pkill mongos
# pkill -f -9 '/u01/colombo/mongodb/bin/mongos -f /u01/colombo/etc/mongodb/wt-router.conf'
# /u01/colombo/mongodb/bin/mongos -f /u01/colombo/etc/mongodb/wt-router.conf
# kiem tra ket qua bang lenh db.adminCommand({ getShardMap: 1 })

# cau hinh node shard, hoac la 3 node, hoac la 2 node + 1 node arbiter
# tao duong dan luu storage
mkdir -p /u01/colombo/mongodb/shard-wt-1
vi /u01/colombo/etc/mongodb/shard-wt-1.conf
storage:
        dbPath: "/u01/colombo/mongodb/shard-wt-1"
        engine: wiredTiger
        wiredTiger:
            engineConfig:
                cacheSizeGB: 3
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb/shard-wt-1.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27018
        maxIncomingConnections: 2000000
        #serviceExecutor: adaptive
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb/shard-wt-1.pid"
replication:
        replSetName: shard-wt-1
        oplogSizeMB: 1024
sharding:
        clusterRole: shardsvr
        #archiveMovedChunks: false
#security:
#        authorization: enabled
#        keyFile: "/u01/colombo/mongodb/mongodb-keyfile"
#        transitionToAuth: true
setParameter:
  internalQueryExecMaxBlockingSortBytes: 335544320

#khoi dong shard 27018 tren cac node
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf
// CHU Y NEU TRONG CONFIG MONGO KHONG CO sharding: clusterRole: configsvr THI KHONG SU DUNG configsvr
// CHU Y NEU THAY DOI CONFIG MONGO THI CAN RESTART CAC NODE TRUOC KHI INITIATE
# dung cong cu mongosh de cau hinh
/u01/colombo/mongodb/bin/mongosh --port 27018
rs.initiate({
  _id: "shard-wt-1",
  members: [
    { _id: 0, host: "10.60.155.240:27018", priority: 10 },
    { _id: 1, host: "10.60.155.188:27018", priority: 1 },
  ]
})
rs.initiate({
  _id: "shard-wt-2",
  members: [
    { _id: 0, host: "10.60.155.240:27028", priority: 10 },
    { _id: 1, host: "10.60.155.188:27028", priority: 1 },
  ]
})

# cau hinh tren cac shard
# Primary ghi full t·ªëc ƒë·ªô, kh√¥ng quan t√¢m Secondary, mac dinh Primary s·∫Ω t·ª± ƒë·ªông gi·∫£m t·ªëc ƒë·ªô ghi n·∫øu Secondary b·ªã tr·ªÖ dam bao dong bo va on dinh
#db.adminCommand( { setParameter: 1, enableFlowControl: false } )
# TƒÉng gi·ªõi h·∫°n b·ªô nh·ªõ (RAM) ƒë∆∞·ª£c ph√©p d√πng cho c√°c truy v·∫•n c√≥ sort/blocking stage. M·∫∑c ƒë·ªãnh MongoDB gi·ªõi h·∫°n kho·∫£ng 100 MB, tang lenh 320 MB
#db.adminCommand({setParameter: 1, internalQueryExecMaxBlockingSortBytes: 335544320})
# tao role moi co toan quyen
db.createRole( { role: "executeFunctions", privileges: [ { resource: { anyResource: true }, actions: [ "anyAction" ] } ], roles: [] } )
# C·∫•p quy·ªÅn role v·ª´a t·∫°o cho user colombo
db.grantRolesToUser("colombo",["executeFunctions"])

# cau hinh node router
vi /u01/colombo/etc/mongodb/wt-router.conf
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb/wt-router.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27017
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb/wt-router.pid"
sharding:
        configDB: wtconfig/10.60.155.240:27019,10.60.155.165:27019
#security:
        #authorization: enabled
#        keyFile: "/u01/colombo/mongodb/mongodb-keyfile"
        #transitionToAuth: true

# khoi dong router tren cac node
/u01/colombo/mongodb/bin/mongos -f /u01/colombo/etc/mongodb/wt-router.conf
# K·∫øt n·ªëi v√†o mongos v√† th√™m shards
# K·∫øt n·ªëi v√†o 1 mongos:
/u01/colombo/mongodb/bin/mongosh --port 27017
# Th√™m shards:
sh.addShard("shard-wt-1/10.60.155.240:27018,10.60.155.188:27018")
sh.addShard("shard-wt-2/10.60.155.240:27028,10.60.155.188:27028")
# kiem tra ket qua bang lenh db.adminCommand({ getShardMap: 1 })
# B·∫≠t sharding cho database v√† collection
#sh.enableSharding("mydb")
sh.enableSharding('colombo10263')
#tao hash
#sh.shardCollection("mydb.users", { _id: "hashed" })
var collections = {
  "AccessToken": "_id",
  "Article": "_id",
  "Comment": "_id",
  "Courseware": "_id",
  "Group": "_id",
  "OrderTransaction": "_id",
  "Reservation": "_id",
  ...
  "CoreDecl_tl": "type2",
  "CoreDecl_vi": "type2",
  "CoreDecl_zh-CN": "type2"
};
use colombo10263
for(var c in collections){
            	var key = collections[c], index = {};
            	index[key] = 'hashed';
            	db[c].createIndex(index);
            	sh.shardCollection('colombo10263.' + c, index) //sh.shardCollection('colombo10263.CoreDecl_vi', {type2: 'hashed'})
}

# Ki·ªÉm tra tr·∫°ng th√°i
sh.status()
#S·ª≠ d·ª•ng l·ªánh rs.status() ƒë·ªÉ check tr·∫°ng th√°i c√°c node trong replica. ƒê·∫£m b·∫£o c√°c node ·ª©ng d·ª•ng ƒë·ªÅu ·ªü tr·∫°ng th√°i Primary/Secondary
#S·ª≠ d·ª•ng l·ªánh rs.stepDown(30, 30) ƒë·ªÉ check ƒë√°nh gi√° Down Primary h·ªá th·ªëng t·ª± ƒë·ªông chuy·ªÉn primary sang Secondary.
#S·ª≠ d·ª•ng l·ªánh db.serverStatus().connections ƒë·ªÉ check s·ªë session ƒëang ƒë∆∞·ª£c active tr√™n c·ª•m Database

# them node arbiter chi de bau chon, Tr√°nh m·∫•t majority, khong luu data, cung port voi 2 shard cua 2 node truoc do
# tao duong dan luu storage
mkdir -p /u01/colombo/mongodb/arbiter-shard-wt-1
mkdir -p /u01/colombo/mongodb/arbiter-shard-wt-2
storage:
        dbPath: "/u01/colombo/mongodb/arbiter-shard-wt-1"
        engine: wiredTiger
        wiredTiger:
            engineConfig:
                cacheSizeGB: 3
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb/arbiter-shard-wt-1.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27018
        maxIncomingConnections: 2000000
        #serviceExecutor: adaptive
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb/arbiter-shard-wt-1.pid"
replication:
        replSetName: shard-wt-1
        oplogSizeMB: 1024

# K·∫øt n·ªëi v√†o mongos
# V√≠ d·ª• b·∫°n c√≥ router ·ªü port 27017:
/u01/colombo/mongodb/bin/mongosh --port 27017
# Thi·∫øt l·∫≠p default read/write concern
# majority - cho cho da so thanh vien xac nhan, du lieu dc replicate
db.adminCommand({
  setDefaultRWConcern: 1,
  defaultWriteConcern: { w: "majority" }, 
  defaultReadConcern: { level: "majority" } 
})
#khoi dong cac node arbiter voi cac shard
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/arbiter-shard-wt-1.conf
#vao node primary cua shard, ket noi node arbiter
/u01/colombo/mongodb/bin/mongosh --port 27018
rs.addArb("10.60.155.xxx:27018")

# lenh stop mongod neu can 
# /u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf --shutdown
# pkill -f -9 '/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf'
# /u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf --shutdown
# pkill -f -9 '/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf'

# cau hinh cum inMemory 
mkdir -p /u01/colombo/var/log/mongodb1
mkdir -p /u01/colombo/var/run/mongodb1
mkdir -p /u01/colombo/etc/mongodb1
mkdir -p /u01/colombo/mongodb1/core-config
vi /u01/colombo/etc/mongodb1/core-config.conf
storage:
        dbPath: "/u01/colombo/mongodb1/core-config"
        engine: wiredTiger
        wiredTiger:
            engineConfig:
                cacheSizeGB: 1
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb1/core-config.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27119
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb1/core-config.pid"
replication:
        replSetName: core-config
        oplogSizeMB: 256
sharding:
        clusterRole: configsvr
        #archiveMovedChunks: false
security:
        authorization: enabled
        keyFile: "/u01/colombo/mongodb1/mongodb-keyfile"
        transitionToAuth: true

// CHU Y NEU TRONG CONFIG MONGO KHONG CO sharding: clusterRole: configsvr THI KHONG SU DUNG configsvr
// CHU Y NEU THAY DOI CONFIG MONGO THI CAN RESTART CAC NODE TRUOC KHI INITIATE
/u01/colombo/mongodb1/bin/mongosh --port 27119
rs.initiate({
  _id: "core-config",
  configsvr: true,
  members: [
    { _id: 0, host: "10.60.155.240:27119", priority: 10 },
    { _id: 1, host: "10.60.155.188:27119", priority: 2 },
    { _id: 2, host: "10.60.155.165:27119", priority: 1 }
  ]
})

# cau hinh node shard
mkdir -p /u01/colombo/mongodb1/core-shard-1
vi /u01/colombo/etc/mongodb1/core-shard-1.conf
storage:
        dbPath: "/u01/colombo/mongodb1/core-shard-1"
        #engine: wiredTiger
        #wiredTiger:
        #    engineConfig:
        #        cacheSizeGB: 3
        engine: inMemory
        inMemory:
            engineConfig:
                inMemorySizeGB: 4
systemLog:
        destination: file
        path: "/u01/colombo/var/log/mongodb1/core-shard-1.log"
        logAppend: true
        logRotate: reopen
net:
        bindIp: 0.0.0.0
        port: 27118
        maxIncomingConnections: 2000000
        #serviceExecutor: adaptive
processManagement:
        fork: true
        pidFilePath: "/u01/colombo/var/run/mongodb1/core-shard-1.pid"
replication:
        replSetName: core-shard-1
        oplogSizeMB: 1024
sharding:
        clusterRole: shardsvr
        #archiveMovedChunks: false
security:
        authorization: enabled
        keyFile: "/u01/colombo/mongodb1/mongodb-keyfile"
        transitionToAuth: true
#setParameter:
#  internalQueryExecMaxBlockingSortBytes: 335544320

#khoi dong shard 27118 tren cac node
/u01/colombo/mongodb1/bin/mongod -f /u01/colombo/etc/mongodb1/core-shard-1.conf
// CHU Y NEU TRONG CONFIG MONGO KHONG CO sharding: clusterRole: configsvr THI KHONG SU DUNG configsvr
// CHU Y NEU THAY DOI CONFIG MONGO THI CAN RESTART CAC NODE TRUOC KHI INITIATE
# dung cong cu mongosh de cau hinh
/u01/colombo/mongodb1/bin/mongosh --port 27118
rs.initiate({
  _id: "core-shard-1",
  writeConcernMajorityJournalDefault: false,
  members: [
    { _id: 0, host: "10.60.155.240:27118", priority: 10 },
    { _id: 1, host: "10.60.155.188:27118", priority: 2 },
    { _id: 2, host: "10.60.155.165:27118", priority: 0 },
  ]
})

mkdir -p /u01/colombo/mongodb1/core-shard-2
/u01/colombo/mongodb1/bin/mongod -f /u01/colombo/etc/mongodb1/core-shard-2.conf
# dung cong cu mongosh de cau hinh
/u01/colombo/mongodb1/bin/mongosh --port 27128
rs.initiate({
  _id: "core-shard-2",
  writeConcernMajorityJournalDefault: false,
  members: [
    { _id: 0, host: "10.60.155.240:27128", priority: 10 },
    { _id: 1, host: "10.60.155.188:27128", priority: 0 },
    { _id: 2, host: "10.60.155.165:27128", priority: 2 },
  ]
})

#restore toan bo
/u01/colombo/mongodb1/bin/mongorestore  --port 27117 --authenticationDatabase admin -u colombo -p P0rtalmongo#123DLVB --verbose --db colombo10263 /u01/colombo/backup/colombo10263 --gzip
# restore theo chi dinh, restore lai index, vao router de thuc hien
/u01/colombo/mongodb/bin/mongorestore --host 10.0.140.167 --port 8299 --authenticationDatabase=admin -u colombo -p Mongodb#25CSBVT --db colombo10263 /u01/colombo/restore/colombo10263/index
# B·∫≠t sharding cho database v√† collection
#sh.enableSharding("mydb")
sh.enableSharding('colombo10263')
#tao hash
#sh.shardCollection("mydb.users", { _id: "hashed" })
var collections = {
  "AccessToken": "_id",
  "Article": "_id",
  "Comment": "_id",
  "Courseware": "_id",
  "Group": "_id",
  "OrderTransaction": "_id",
  "Reservation": "_id",
  ...
  "CoreDecl_tl": "type2",
  "CoreDecl_vi": "type2",
  "CoreDecl_zh-CN": "type2"
};
use colombo10263
for(var c in collections){
            	var key = collections[c], index = {};
            	index[key] = 'hashed';
            	db[c].createIndex(index);
            	sh.shardCollection('colombo10263.' + c, index) //sh.shardCollection('colombo10263.CoreDecl_vi', {type2: 'hashed'})
}
#restore data
/u01/colombo/mongodb/bin/mongorestore --host 10.0.140.167 --port 8299 --authenticationDatabase=admin -u colombo -p xxxx --db colombo10263 /u01/colombo/restore/colombo10263/data
#khi can update collections, vao port router
/u01/colombo/mongodb/bin/mongorestore --host 10.0.140.167 --port 8299 --authenticationDatabase=admin -u colombo -p xxxx --db colombo10263 --collection Category /u01/colombo/restore/update/CoreDecl.bson.gz --gzip

#lenh thuong dung
#khoi dong
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf
/u01/colombo/mongodb1/bin/mongod -f /u01/colombo/etc/mongodb1/core-shard-1.conf
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf
/u01/colombo/mongodb/bin/mongos -f /u01/colombo/etc/mongodb/csbcorerouter.conf
# lenh stop
/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf --shutdown
pkill -f -9 '/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/wtconfig.conf'

/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf --shutdown
pkill -f -9 '/u01/colombo/mongodb/bin/mongod -f /u01/colombo/etc/mongodb/shard-wt-1.conf'

/u01/colombo/mongodb/bin/mongosh admin --host 10.0.140.167 --port 8299 --authenticationDatabase=admin -u colombo -p Mongodb#25CSBVT --eval "db.shutdownServer()"
pkill -f -9 '/u01/colombo/mongodb/bin/mongos -f /u01/colombo/etc/mongodb/csbcorerouter.conf'

#kiem tra log
tail -n 100 /u01/colombo/var/log/mongodb/csbcoreconfig.log
#trang thai, thay doi port can kiem tra service cho phu hop
/u01/colombo/mongodb/bin/mongosh --host=10.0.140.167 --port=8300 --authenticationDatabase=admin -u colombo -p xxxx colombo10263 --eval "rs.secondaryOk();var status = rs.status().members; for(var i in status){print(status[i].name+' '+status[i].stateStr);}"
#console
/u01/colombo/mongodb/bin/mongosh --host=10.0.140.167 --port 8300 --authenticationDatabase=admin -u colombo -p xxxx colombo10263
#backup
/u01/colombo/mongodb/bin/mongodump --host 127.0.0.1 --port=27017 --db $db  --authenticationDatabase=admin -u colombo -p xxx --out $FILE --gzip

DBCore:
mongodb://colombo:P0rtalmongo#123DLVB@10.60.155.240:27117,10.60.155.165:27117/colombo10263?authSource=admin&readPreference=secondaryPreferred&retryWrites=true

DBWT:
mongodb://colombo:P0rtalmongo#123DLVB@10.60.155.240:27017,10.60.155.165:27017/colombo10263?authSource=admin&readPreference=secondaryPreferred&retryWrites=true

### CAU HINH CUM REPLICA ONLY, NO SHARD
#chu y doi cac duong dan phu hop, neu chua co thi tao moi truoc, cau hinh giong nhau tren ca 3 node
vi /etc/mongod.conf
systemLog:
  destination: file
  path: /data/mongo/log/mongod.log
  logAppend: true

storage:
  dbPath: /data/mongo/db
  journal:
    enabled: true

net:
  port: 27017
  bindIp: 0.0.0.0

processManagement:
  fork: true

replication:
  replSetName: rs0

#khoi dong
mongod -f /etc/mongod.conf
#kiem tra
ps aux | grep mongod
#KH·ªûI T·∫†O REPLICA SET (CH·ªà L√ÄM 1 L·∫¶N)
üëâ Th·ª±c hi·ªán ch·ªâ tr√™n node1
mongosh
rs.initiate({
  _id: "rs0",
  members: [
    { _id: 0, host: "node1:27017", priority: 2 },
    { _id: 1, host: "node2:27017", priority: 1 },
    { _id: 2, host: "node3:27017", priority: 1 }
  ]
})
‚è≥ Ch·ªù ~5‚Äì10 gi√¢y
#Ki·ªÉm tra tr·∫°ng th√°i
rs.status()
B·∫°n s·∫Ω th·∫•y:
node1 ‚Üí PRIMARY
node2, node3 ‚Üí SECONDARY
#bat tat mot not de kiem tra failover
#B·∫¨T AUTH + KEYFILE tuong tu cum shard rs
T·∫°o user admin (tr√™n PRIMARY)
use admin
db.createUser({
  user: "admin",
  pwd: "StrongPassword",
  roles: [ { role: "root", db: "admin" } ]
})
K·∫øt n·ªëi:
mongosh -u admin -p --authenticationDatabase admin
