#Kiểm tra 2 NIC trên Ubuntu Router
#Chạy trên Ubuntu router:
ip a
ens33 → Bridged (có IPv4 từ router thật, ví dụ 192.168.1.x)
ens34 → Host-only / VMnet10 (có thể chưa có IP)

#Nếu ens34 chưa có IP → đặt IP tĩnh cho nó.
sudo vi /etc/netplan/01-netcfg.yaml
network:
  version: 2
  ethernets:
    ens34:
          addresses:
            - 10.10.0.1/24

sudo netplan apply

#Bật IP Forwarding (cho phép kernel làm router)
echo "net.ipv4.ip_forward=1" | sudo tee /etc/sysctl.d/99-sysctl.conf
sudo sysctl -p /etc/sysctl.d/99-sysctl.conf
#hoac
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
sysctl -p


# 3 cach cau hinh NAT

##Cấu hình NAT bằng nftables
#mac dinh ubuntu 24 co san, hoac kiem tra chua co thi cai
sudo apt install nftables
sudo systemctl enable --now nftables

sudo vi /etc/nftables.conf
#!/usr/sbin/nft -f

flush ruleset
table ip nat {
    chain prerouting {
        type nat hook prerouting priority -100; # so am 100 uu tien nat xu ly som truoc khi filter
    }

    chain postrouting {
        type nat hook postrouting priority 100; #so duong 100 xu ly muon truoc khi goi tin roi di duoc gan ip mang bridged
        oif "ens33" masquerade     # NAT ra interface bridged
    }
}
table ip filter {
    chain input {
        type filter hook input priority 0; #0 muc uu tien chuan
        accept
    }
    chain forward {
        type filter hook forward priority 0; #0 muc uu tien chuan
        iif "ens34" oif "ens33" accept   # Cho phép private → internet
        iif "ens33" oif "ens34" ct state related,established accept
        drop
    }
    chain output {
        type filter hook output priority 0; #0 muc uu tien chuan
        accept
    }
}

sudo systemctl restart nftables


##Cấu hình NAT bằng iptables, chu y kiem tra da duoc Bật IP Forwarding tren may nat
#neu muon xoa cau hinh cu
#sudo iptables -F
#sudo iptables -t nat -F
#sudo iptables -X

#Bạn muốn NAT từ private (ens34) → ra Bridged (ens33):
#Thiết lập MASQUERADE, tat ca goi tin di ra ens33 se bi doi ip nguon thành IP của ens33.:
sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE

#cho phép forward, NAT từ private (ens34) → ra Bridged (ens33):
sudo iptables -A FORWARD -i ens34 -o ens33 -j ACCEPT

#chuyen tiep goi tin qua router, incoming interface di vao tu ens33, outgoing interface di ra qua ens34, -m state load module state theo doi trang thai ket noi co the voi module moi la -m conntract --ctstate, ESTABLISHED goi tin thuoc mot ket noi da duoc thiet lap tu truoc luc nay dang quay ve, RELATED co lien quan den ket noi da co, khong match ket noi moi hoac goi loi, -j accept cho phep qua
#cho phep goi tin phan hoi cua snat/masquerate quay ve, khong phai la goi tin DNAT ma la goi tin phan hoi
sudo iptables -A FORWARD -i ens33 -o ens34 -m state --state RELATED,ESTABLISHED -j ACCEPT

#neu muon chan toan bo cac forward khac
#sudo iptables -A FORWARD -j DROP

#Lưu iptables để khởi động lại không mất:
sudo apt install iptables-persistent -y
sudo netfilter-persistent save

#xem ket qua cau hinh,
#-L : list rule
#-v : chi tiết (packet, byte count)
#-n : không resolve DNS (xem nhanh hơn)
sudo iptables -L -v -n
#chi xem nat table
sudo iptables -t nat -L -v -n
#Xem rule hien thi theo dạng lệnh
 sudo iptables-save
 #Hoặc chỉ NAT:
 sudo iptables-save | grep nat -A20
#Kiểm tra packet counter (để biết rule có “ăn” traffic không). neu kts, bytes tăng → rule đang hoạt động
sudo iptables -L FORWARD -v -n --line-numbers


##Cấu hình netplan các VM trong cụm (client VM)
addresses: [10.10.0.10/24]
gateway4: 10.10.0.1 
#hoac 
routes: 
  - to: 0.0.0.0/0
    via: 10.10.0.1

sudo netplan apply

##Cau hinh nat bang firewalld thuong trên CentOS
firewall-cmd --zone=public --add-masquerade --permanent
firewall-cmd --reload
firewall-cmd --zone=public --add-masquerade --permanent
firewall-cmd --reload
#Hoặc cấu hình forward:
firewall-cmd --add-forward-port=port=80:proto=tcp:toport=8080
