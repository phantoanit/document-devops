Ch√∫ng ta d√πng:
- Apache Kafka
- Strimzi
- Ch·∫ø ƒë·ªô KRaft (kh√¥ng ZooKeeper)
- Storage LocalPV/OpenEBS (ph√π h·ª£p v·ªõi Kafka)

Namespace: kafka
Kafka Cluster (KRaft):
- 3 Controller nodes
- 3 Broker nodes
- Persistent Volume
- Replication factor = 3
- min.insync.replicas = 2

Kafka Connect (Debezium) ‚Äì deploy ri√™ng

Production n√™n t√°ch:
Controller nodes
Broker nodes
Kh√¥ng n√™n ch·∫°y combined mode cho production l·ªõn.


B∆Ø·ªöC 1 ‚Äì Chu·∫©n b·ªã StorageClass
OpenEBS LocalPV
Ho·∫∑c local SSD

B∆Ø·ªöC 2 ‚Äì C√†i Strimzi Operator
kubectl create namespace kafka
C√†i operator:
kubectl apply -f https://strimzi.io/install/latest?namespace=kafka -n kafka
kubectl get pods -n kafka

B∆Ø·ªöC 3 ‚Äì Deploy Kafka Cluster (KRaft chu·∫©n production)

cau hinh dual-role (combined mode) ‚Äî t·ª©c m·ªói pod v·ª´a l√† broker + controller, mot so version cu thi combined mode la mac dinh nhung van nen cau hinh cu the 
vi kafka-nodepool.yaml
apiVersion: kafka.strimzi.io/v1
kind: KafkaNodePool
metadata:
  name: dual-role
  namespace: kafka
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  roles:
    - broker
    - controller
  storage:
    type: persistent-claim
    size: 0.5Gi
    class: openebs-localpv
    deleteClaim: false

kubectl apply -f kafka-nodepool.yaml

File: kafka-prod.yaml
apiVersion: kafka.strimzi.io/v1
kind: Kafka
metadata:
  name: my-cluster
  namespace: kafka
spec:
  kafka:
    version: 4.1.1
    metadataVersion: 4.1-IV0
    listeners:
      - name: internal
        port: 9092
        type: internal
        tls: false
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      #transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
      #log.retention.hours: 168
      #log.segment.bytes: 1073741824

  entityOperator:
    topicOperator: {}
    userOperator: {}

kubectl apply -f kafka-prod.yaml

KRaft ƒë∆∞·ª£c k√≠ch ho·∫°t t·ª± ƒë·ªông khi c√≥ NodePool role=controller.

kubectl get kafkanodepool -n kafka
kubectl get kafka -n kafka
kubectl get pods -n kafka

Ki·ªÉm tra cluster health
kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list

Thu tao topic
kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
/opt/kafka/bin/kafka-topics.sh \
--bootstrap-server localhost:9092 \
--create \
--topic test \
--partitions 3 \
--replication-factor 3

kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
/opt/kafka/bin/kafka-topics.sh \
--bootstrap-server localhost:9092 \
--list

kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
/opt/kafka/bin/kafka-topics.sh \
--bootstrap-server localhost:9092 \
--describe \
--topic test

Enable Authentication (Production b·∫Øt bu·ªôc)
V√≠ d·ª• b·∫≠t SCRAM:
listeners:
  - name: internal
    port: 9092
    type: internal
    tls: true
    authentication:
      type: scram-sha-512


T·∫°o user:
apiVersion: kafka.strimzi.io/v1
kind: KafkaUser
metadata:
  name: app-user
  namespace: kafka
spec:
  authentication:
    type: scram-sha-512

kubectl apply -f kafka-user.yaml

B∆Ø·ªöC 5 ‚Äì Deploy Kafka Connect (cho Debezium)

Build Custom Kafka Connect Image truoc, neu dung mac dinh co the loi Class io.debezium.connector.mysql.MySqlConnector not found
- Kafka Connect base image c·ªßa Strimzi
- Debezium plugin
- C√°c connector kh√°c n·∫øu c·∫ßn

T·∫°o Dockerfile
FROM quay.io/strimzi/kafka:0.46.0-kafka-4.1.1
USER root
RUN mkdir -p /opt/kafka/plugins/debezium \
 && curl -L https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/2.5.0.Final/debezium-connector-mysql-2.5.0.Final-plugin.tar.gz \
 | tar -xz -C /opt/kafka/plugins/debezium
USER 1001


docker build -t registry.local/kafka-connect:4.1.1-debezium .
docker push registry.local/kafka-connect:4.1.1-debezium

File: kafka-connect.yaml
apiVersion: kafka.strimzi.io/v1
kind: KafkaConnect
metadata:
  name: kafka-connect
  namespace: kafka
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  replicas: 3
  bootstrapServers: my-cluster-kafka-bootstrap:9092
  image: harbor.coquan.vn/library/kafka-connect-debezium:2.5

  groupId: connect-cluster
  offsetStorageTopic: connect-offsets
  configStorageTopic: connect-configs
  statusStorageTopic: connect-status

  config:
    offset.storage.replication.factor: 3
    config.storage.replication.factor: 3
    status.storage.replication.factor: 3
    plugin.path: /opt/kafka/plugins

    key.converter: org.apache.kafka.connect.json.JsonConverter
    value.converter: org.apache.kafka.connect.json.JsonConverter
    key.converter.schemas.enable: false
    value.converter.schemas.enable: false

kubectl apply -f kafka-connect.yaml


B∆Ø·ªöC 6 ‚Äì Deploy Debezium Connector
V√≠ d·ª• MySQL:
apiVersion: kafka.strimzi.io/v1
kind: KafkaConnector
metadata:
  name: mysql-connector
  namespace: kafka
spec:
  class: io.debezium.connector.mysql.MySqlConnector
  tasksMax: 1
  config:
    database.hostname: mysql
    database.port: 3306
    database.user: debezium
    database.password: password
    database.server.id: 184054
    database.server.name: dbserver1
    topic.prefix: mysql

vi du Debezium YugabyteDB Connector (PostgreSQL-compatible):
Y√™u c·∫ßu YugabyteDB YugabyteDB v2.14+ (khuy·∫øn ngh·ªã m·ªõi h∆°n)
B·∫≠t logical replication (m·∫∑c ƒë·ªãnh Yugabyte ƒë√£ h·ªó tr·ª£)
User c√≥ quy·ªÅn:
REPLICATION
LOGIN

V√≠ d·ª• t·∫°o user:
CREATE ROLE debezium WITH LOGIN PASSWORD 'dbzSaasVHV2627' REPLICATION;
GRANT ALL PRIVILEGES ON DATABASE vhv_saas TO debezium;

KafkaConnector (Yugabyte / PostgreSQL)
apiVersion: kafka.strimzi.io/v1
kind: KafkaConnector
metadata:
  name: yugabyte-connector
  namespace: kafka
  labels:
    strimzi.io/cluster: kafka-connect
spec:
  class: io.debezium.connector.postgresql.PostgresConnector
  tasksMax: 1
  config:
    database.hostname: yb-tservers.yugabyte.svc.cluster.local
    database.port: 5433
    database.user: debezium
    database.password: dbzSaasVHV2627
    database.dbname: vhv_saas
    topic.prefix: cdc

    plugin.name: pgoutput
    slot.name: debezium_slot
    publication.autocreate.mode: filtered

    table.include.list: public.users

    schema.history.internal.kafka.bootstrap.servers: my-cluster-kafka-bootstrap:9092
    schema.history.internal.kafka.topic: schema-changes.yugabyte

kubectl apply -f yugabyte-connector.yaml

kubectl get kafkaconnector -n kafka

Consume test:
kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
 /opt/kafka/bin/kafka-console-consumer.sh \
 --bootstrap-server localhost:9092 \
 --topic cdc.public.users \
 --from-beginning

kubectl exec -it my-cluster-dual-role-0 -n kafka -- \
 /opt/kafka/bin/kafka-topics.sh \
 --bootstrap-server localhost:9092 \
 --list


B∆Ø·ªöC 7 ‚Äì Monitoring (Production b·∫Øt bu·ªôc)
B·∫≠t metrics trong Kafka:
metricsConfig:
  type: jmxPrometheusExporter

C√†i:
Prometheus
Grafana
Alertmanager

‚ö†Ô∏è Nh·ªØng sai l·∫ßm ph·ªï bi·∫øn khi d√πng KRaft
‚ùå Kh√¥ng t√°ch controller khi cluster l·ªõn
‚ùå D√πng storage network ch·∫≠m
‚ùå replication.factor < 3
‚ùå Kh√¥ng set min.insync.replicas
‚ùå Kh√¥ng monitor consumer lag

üéØ Checklist Production Chu·∫©n
‚úî 3 broker t·ªëi thi·ªÉu
‚úî replication.factor=3
‚úî min.insync.replicas=2
‚úî TLS b·∫≠t
‚úî Authentication b·∫≠t
‚úî Storage LocalPV
‚úî deleteClaim=false
‚úî Monitoring ƒë·∫ßy ƒë·ªß
