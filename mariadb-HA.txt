#list server and setup
apt install -y net-tools telnet traceroute
apt install -y mariadb-server mariadb-client

#server-1
#galera cluster /etc/mysql/conf.d/galera.cnf
[mysqld]
binlog_format=ROW
default-storage-engine=innodb
innodb_autoinc_lock_mode=2
bind-address=0.0.0.0

# Galera Provider Configuration
wsrep_on=ON
wsrep_provider=/usr/lib/galera/libgalera_smm.so

# Cluster Configuration
wsrep_cluster_name="mariadb-cluster-toandevops"
wsrep_cluster_address="gcomm://192.168.213.11,192.168.213.12,192.168.213.13"

# Galera Synchronization Configuration
wsrep_sst_method=rsync

# Node Configuration
wsrep_node_address="192.168.213.11"
wsrep_node_name="server-1"

#server-2 va 3 tuong tu thay doi wsrep_node_address & wsrep_node_name
#cau hinh bind mysql va duong dan luu data neu muon
sudo mkdir -p /u01/colombo/var/lib/mysql
sudo vi /etc/mysql/mariadb.conf.d/50-server.cnf
datadir = 
bind-address = 0.0.0.0

#start cluster
#server-1
systemctl stop mariadb
galera_new_cluster

#kiem tra
mysql -u root -e "SHOW STATUS LIKE 'wsrep_cluster_size'"

#server-2,3
systemctl restart mariadb

#Kiểm tra tính đồng bộ dữ liệu Thực hiện trên server 1
mysql
MariaDB [(None)]> create database devopseduvndb;
MariaDB [(None)]> use devopseduvndb;
MariaDB [devopseduvndb]> create table series (Name VARCHAR(50) PRIMARY KEY, Lever VARCHAR(25), Release_date DATE);
MariaDB [devopseduvndb]> insert into series (Name, Lever, Release_date) VALUES ('DevOps for Freshers', 'Basic/Freshers', '2024-01-15'), ('Xây dựng quy trình pipeline DevSecOps', 'Thực tế chuyên sâu', '2024-06-16'), ('HA tools', 'Advanced/Thực tế', '2024-08-18');

#Kiểm tra tính đồng bộ dữ liệu Thực hiện trên server 2 hoặc server 3
mysql
MariaDB [(None)]> use devopseduvndb;
MariaDB [devopseduvndb]> show databases;
MariaDB [devopseduvndb]> show tables;
MariaDB [devopseduvndb]> select * from series;

#ket hop voi maxscale, Tránh xung đột ghi neu nhieu client cung khi tren mot dong du lieu o nhieu node khac nhau, maxscale se tu bau chon 1 master lam node write con lai la slave - read only, khi master co su co maxscale se tu xu ly bau chon lai nhanh chong
#install maxscale, neu cai tren ubuntu24.04 thi chuyen cach khac
wget https://dlm.mariadb.com/2344079/MaxScale/6.4.1/packages/ubuntu/jammy/x86_64/maxscale-6.4.1-1.ubuntu.jammy.x86_64.deb
dpkg -i maxscale-6.4.1-1.ubuntu.jammy.x86_64.deb
# neu la ubuntu 24.04
curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash
sudo apt install -y maxscale

#cau hinh maxscale tren cac node
sudo cp /etc/maxscale.cnf /etc/maxscale.cnf.org
sudo vi /etc/maxscale.cnf
#cau hinh du cac block server1, server2, ...
#block monitor khai bao du server1, server2, .. cau hinh tai khoan va mat khau ket noi thoi mariadb - co the tao tai khoan sau roi moi start maxscale
#block read only service: khai bao cac node cho phep read, thuong thi khai bao het dam bao HA, cau hinh dung user va pass
#block read write service: khai bao cac node cho web write, thuong thi khai bao het dam bao HA, cau hinh dung user va pass

#create user connect maxscale
CREATE USER 'maxscale'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION CLIENT ON *.* TO 'maxscale'@'%';
GRANT REPLICATION SLAVE ADMIN ON *.* TO 'maxscale'@'%';
GRANT REPLICA MONITOR ON *.* TO 'maxscale'@'%';
FLUSH PRIVILEGES;

sudo systemctl start maxscale
#kiem tra cum
maxctrl list servers


############# docker compose ###############
version: '3.7'

services:
  node1:
    image: mariadb:10.5
    container_name: node1
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=testdb
    volumes:
      - ./node1/galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      galera:
        aliases:
          - node1
    ports:
      - "3307:3306"
    command: [
      "mysqld",
      "--wsrep-new-cluster"
    ]
  node2:
    image: mariadb:10.5
    container_name: node2
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - ./node2/galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      galera:
        aliases:
          - node2
    ports:
      - "3308:3306"

  node3:
    image: mariadb:10.5
    container_name: node3
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - ./node3/galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      galera:
        aliases:
          - node3
    ports:
      - "3309:3306"

networks:
  galera:
    driver: bridge

# Start node1 đầu tiên và bootstrap Galera cluster:
docker-compose up -d node1
docker exec -it node1 bash
mysqld --wsrep-new-cluster --user=mysql
# Khởi động node2 và node3:
docker-compose up -d node2 node3
#trong từng node để kiểm tra cluster:
docker exec -it node1 mysql -uroot -proot -e "SHOW STATUS LIKE 'wsrep_cluster_size';"

# neu su dung replication truyền thống (asynchronous)
# my.cnf
[mysqld]
server-id=1
log-bin=mysql-bin
# neu la slave
read_only=1

# ạo user replication và cấp quyền
CREATE USER 'replicator'@'%' IDENTIFIED BY 'replpass';
GRANT REPLICATION SLAVE ON *.* TO 'replicator'@'%';
FLUSH PRIVILEGES;

SHOW MASTER STATUS;

File: ví dụ mysql-bin.000001
Position: ví dụ 1234

# join vao master, cau hinh de dong bo
CHANGE MASTER TO
  MASTER_HOST='master',
  MASTER_USER='replicator',
  MASTER_PASSWORD='replpass',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=1234;

START SLAVE;
# kiem tra dong bo, Slave_IO_Running: yes, Slave_SQL_Running: yes
SHOW SLAVE STATUS\G

	
